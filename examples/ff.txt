from lib import SignedBy
from lib import IncludedAt

@library
@quantifier("tx.block${b}.range${token},ITER,${zero}")
def Tx(tx, token, b, owner) :=
  Equal(tx.3.address, $OwnershipAddress)
  and Equal(tx.3.0, owner)
  and Equal(tx.0, token)
  and Equal(tx.2, b)


def fastFinality(merchant, operator, b, tx) :=
  (SignedBy(tx, merchant).any()
    and SignedBy(tx, operator).any())
  or Tx(tx.0, b, merchant).any(paymentTx ->
    !IncludedAt(paymentTx.3, paymentTx.0, paymentTx.1, paymentTx.2).any()
    and SignedBy(paymentTx, operator).any()
    and SignedBy(tx, merchant).any()
    and IsSameAmount(paymentTx.1, tx.1)
  )
